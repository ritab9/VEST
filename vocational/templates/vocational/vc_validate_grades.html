{%  extends 'base.html' %}

{% load static %}

{% block title %} Validate grades {% endblock title %}


   {% block content %}

       {% if errors %}
            <ul class="errors">
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
       {% endif %}

       {% for message in messages %}
        {%  if message.tags == "info" %}
            <div class="alert-warning spangreen" role="alert" >{{message}}</div>
        {% else %}
            <div class="alert-warning spanred" role="alert" >{{message}}</div>
        {% endif %}
    {% endfor %}

 <!--   Automatic Grade Validation -->
       <!--form method="POST" action="{ % url 'vc_validate_all_grades' schoolid %}">
            { % csrf_token %}
            <input type="submit" class="btn btn-sm btn-danger" value="Validate All Grades">
                    <p class="error">This button will automatically validate all grades except those with SAVED comments in the ‘Not Valid’ section.
                        Please review and SAVE all invalid grades before using this!
                </p>
        </form-->

       <div class="alert alert-info text-muted mb-2">
             Click <em>Fill Today's Date for Quick Validation</em> to approve all grades
            with no issues.
            If a grade is incomplete, leave a comment instead describing what needs to be fixed.
       </div>

       <button type="button" class="btn btn-sm btn-ISEIyellow" id="fill-today-btn" class="btn btn-primary mb-2">
            Fill Today's Date for Quick Validation
        </button>

        <form method="POST">
        {% csrf_token %}
                <input class = "btn btn-sm btn-ISEIblue3 mt-3" name="save" type= "submit" value = "Save All">

            {{ formset.management_form }}

            <div>
                <div class="pagination">
                  {% if page_obj.has_previous %}
                    <a href="?page=1"> << First</a>
                    <a href="?page={{ page_obj.previous_page_number }}"> < Previous</a>
                  {% endif %}

                  <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

                  {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">Next > </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}">Last >> </a>
                  {% endif %}
                </div>
            </div>

            <div>
                {% for form in formset %}
                <table class="table table-sm table-striped table-bordered mt-2 mb-5" style="width: stretch">
                    <thead class="thead-dark">
                        <tr>
                            <th>Quarter</th><th>Student</th><th>Level</th><th>Department</th><th>Instructor</th>
                            <th>Type</th><th>Grade</th><th>Score</th><th>Student Discussed</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ form.instance.quarter.get_name_display }}
                            <br> <div class="span80">{{ form.instancequarter.school_year }}</div>
                            </td>
                            <td>{{ form.instance.student }}</td>
                            <td>{{ form.instance.level }}</td>
                            <td>{{ form.instance.department }}</td><td>{{ form.instance.instructor.last_name }}, {{ form.instance.instructor.first_name }}</td>
                            <td>{{ form.instance.get_type_display }}</td><td>{{ form.instance.percent }}%</td><td>{{ form.instance.score }}</td>
                            <td>{% if form.instance.student_discussed %}
                                    {{ form.instance.student_discussed}}
                                {% else %}
                                    <a href="{% url 'finalize_grade' form.instance.id %}" class="spanred"> Not Yet </a>
                                {% endif %}
                            </td>
                            <td>{{ form.instance.evaluation_date }}<br><div class="span80">{{ form.instance.created_at }}</div></td>
                        </tr>
                        <tr>
                            <td colspan="9">
                                <div class="card card-body" id="details{{ form.instance.id }}">
                                    {% if form.instance.type == "S" %}
                                    <table class="table-sm span80 table-nostriped table-bordered" >
                                        <thead>
                                            <tr>
                                                {% for i in form.instance.ethicssummativegrade_set.all %}
                                                    <th>{{ i.ethic.name }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                {% for i in form.instance.ethicssummativegrade_set.all %}
                                                    <td>{{ i.score }}</td>
                                                {% endfor %}
                                            </tr>
                                            <tr><th colspan="11">Comments:</th> </tr>
                                            {% for i in form.instance.ethicssummativegrade_set.all %}
                                                {% if i.comment %}
                                                    <tr>
                                                    <td>{{ i.ethic.name }}</td>
                                                    <td colspan="10">{{ i.comment }}</td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% else %}
                                     <table class="table-sm w-auto span80 table-nostriped table-bordered">
                                        <thead>
                                            <tr>
                                                {% for i in form.instance.ethicsformativegrade_set.all %}
                                                    <th>{{ i.ethic.name }}</th>
                                                {%  endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                {% for i in form.instance.ethicsformativegrade_set.all %}
                                                    <td>{{ i.score}}</td>
                                                {% endfor %}
                                            </tr>
                                            <tr>
                                                <td colspan="2"><b> Commendations:</b> </td>
                                                <td colspan="8">
                                                    {{ form.instance.commendation }}
                                                </td></tr>
                                            <tr>
                                                <td colspan="2"><b> Recommendations:</b> </td>
                                                 <td colspan="8">
                                                    {{ form.instance.recommendation }}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    {% endif %}

                                {% if form.instance.student_discussion_comment %}
                                    <div class="span80">Student discussion Comment: {{ form.instance.student_discussion_comment }}</div>
                                {% endif %}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" class="">
                                {% if form.instance.suggested_level %}
                                    <div class="spanred">Suggested Level: {{ form.instance.suggested_level }} <br></div>
                                {% endif %}
                                New Level: {{ form.accepted_level }}
                            </td>
                            <td colspan="2" class="spangreen">Enter date to validate: {{ form.vc_validated }}</td>
                            <td colspan="7" class="spanred">Not Valid! Please explain what needs to be changed: {{ form.vc_comment }}</td>
                        </tr>
                    </tbody>
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                </table>
              {% endfor %}

            <input class = "btn btn-sm btn-ISEIblue3 mt-3" name="save" type= "submit" value = "Save All">
            </div>
        </form>


        <script>
            document.getElementById("fill-today-btn").addEventListener("click", function() {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().slice(0,10);

                // Match both textarea and input in case widgets change
                const commentFields = document.querySelectorAll(
                    "input[name$='vc_comment'], textarea[name$='vc_comment']"
                );

                commentFields.forEach(function(commentField) {
                    // Get the matching date field name (form-0-vc_comment → form-0-vc_validated)
                    const dateName = commentField.name.replace(/vc_comment$/, 'vc_validated');

                    // Find that date field anywhere in the DOM
                    const dateField = document.querySelector(`[name="${dateName}"]`);

                    if (!dateField) {
                        alert(`No vc_validated field found for ${commentField.name}`);
                        return;
                    }

                    // Only fill in if comment is empty and date is empty
                    if (commentField.value.trim() === "" && dateField.value.trim() === "") {
                        dateField.value = today;

                        // Trigger change/input event so any JS listeners see it
                        dateField.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
            });

            document.querySelectorAll("input[name$='vc_comment'], textarea[name$='vc_comment']")
              .forEach(function(commentField) {
                commentField.addEventListener("input", function() {
                  const dateName = commentField.name.replace(/vc_comment$/, 'vc_validated');
                  const dateField = document.querySelector(`[name="${dateName}"]`);

                  if (commentField.value.trim() !== "" && dateField && dateField.value.trim() !== "") {
                    dateField.value = "";
                    dateField.dispatchEvent(new Event('input', { bubbles: true }));
                  }
                });
            });
        </script>

    {% endblock content %}

{% block script %}


{% endblock %}
