{% extends 'base.html' %}
{% load static %}

{% block title %} Time Card {% endblock title %}

{% block content %}

{% block navbar %}
    {% include 'navbar_logged_out.html' %}
{% endblock %}

{% if assignment %}
<div class="d-flex justify-content-between">
    <div class="col">
        <h6>{{ assignment.department }}, {% now "F j" %} <br>{{ quarter }}</h6>
    </div>
</div>

<div class="row">
    <div class="col-auto">
        <div style="display: inline-block;">
            <table class="table ">
                <thead class="table-ISEIblue4">
                    <th>Student</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>Time</th>
                    <th>7 day History</th>
                </thead>
                <tbody>
                {% for student in assignment.students %}
                    {% for card in student.today_time_card.all %}
                        <tr {% if student.is_temporary %}class="table-ISEIyellow1"{% endif %}>
                            {% if forloop.first %}
                                <td>{{ student }}
                                </td>
                            {% else %}
                                <td></td>
                            {% endif %}
                            <td>{{ card.get_time_in }}</td>
                            <td>{{ card.get_time_out }}</td>
                            <td>{{ card.duration.0 }} hrs {{ card.duration.1 }} min</td>
                            <td></td>
                        </tr>
                    {% endfor %}

                    <tr {% if student.is_temporary %}class="table-ISEIyellow1"{% endif %}>
                        {% if student.today_time_card %}
                            <td style="border-bottom:1px solid black"></td>
                        {% else %}
                            <td style="border-bottom:1px solid black">{{ student }}</td>
                        {% endif %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="assignment_id" value="{{ assignment.id }}">
                            <input type="hidden" name="student_id" value="{{ student.id }}">
                            {{ form }}
                            {% if student.active_time_card %}
                                <td style="border-bottom:1px solid black">
                                    {{ student.active_time_card.get_time_in }}</td>
                                <td style="border-bottom:1px solid black">
                                    <button class="btn btn-sm btn-ISEIblue4" type="submit" name="action" value="checkout">Check Out</button>
                                </td>
                            {% else %}
                                <td style="border-bottom:1px solid black">
                                    <button class="btn btn-sm btn-ISEIblue4" type="submit" name="action" value="checkin">Check In</button>
                                </td>
                                <td style="border-bottom:1px solid black">
                                    <button class="btn btn-sm btn-ISEIblue4" type="submit" name="action" value="checkout" disabled>Check Out</button>
                                </td>
                            {% endif %}
                        </form>
                        <td style="border-bottom:1px solid black"></td>

                        <!-- View last 7 days' timecards -->
                        <td style="border-bottom:1px solid black">
                            <button type="button" class="btn btn-sm btn-outline-ISEIblue4"
                                    data-bs-toggle="modal" data-bs-target="#weekModal"
                                    data-student-id="{{ student.id }}">
                                Show/Hide History
                            </button>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="col-auto" id="historyCol" style="display:none;">
        <div id="historyContent">
            <!-- History content will be inserted here dynamically -->
        </div>
    </div>

    <!-- Hidden week content for each student -->
        {% for student in assignment.students %}
        <div id="weekContent-{{ student.id }}" style="display:none;">
            {% if student.week_time_cards %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Department</th>
                            <th>Time In</th>
                            <th>Time Out</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for card in student.week_time_cards %}
                            <tr>
                                <td>{{ card.get_date }}</td>
                                <td>{{ card.student_assignment.department }}</td>
                                <td>{{ card.get_time_in }}</td>
                                <td>{{ card.get_time_out }}</td>
                                <td>
                                    {% if card.duration %}
                                        {{ card.duration.0 }} hrs {{ card.duration.1 }} min
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No time cards in the past 7 days.</p>
            {% endif %}
        </div>
    {% endfor %}


    <!-- Temporary student toggle -->
        <div class="col-auto">
            <div class="col text-end">
                <label class="me-2">
                    <input type="checkbox" id="toggle-temp" {% if request.GET.show_temp %}checked{% endif %}>
                    Show Temporary Students
                </label>
            </div>

            <div id="temp-student-form" style="{% if not request.GET.show_temp %}display:none;{% endif %}">
                <form method="post" class="mb-3">
                    {% csrf_token %}
                    {{ temp_student_form.student }}
                    <button type="submit" name="add_temp" class="btn btn-sm btn-outline-ISEIblue4">
                        Add Temporary Student
                    </button>
                </form>
            </div>
        </div>

    </div>

        <!-- Single Modal -->
        <div class="modal fade" id="weekModal" tabindex="-1" aria-labelledby="weekModalLabel" aria-hidden="true">
            <div class="col-auto">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="weekModalLabel">Last 7 Days</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body" id="weekModalBody">
                    <!-- Content loaded dynamically -->
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
        </div>

<script>


    document.querySelectorAll('form button[type="submit"]').forEach(button => {
      button.addEventListener('click', () => {
        button.disabled = true;
        button.form.submit();
      });
    });

    // Show student week content in modal
    const modal = document.getElementById('weekModal');
    modal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const studentId = button.getAttribute('data-student-id');
        const studentContent = document.getElementById('weekContent-' + studentId).innerHTML;
        modal.querySelector('#weekModalBody').innerHTML = studentContent;
    });

    // Temporary student toggle
    document.getElementById('toggle-temp').addEventListener('change', function() {
        const formDiv = document.getElementById('temp-student-form');
        if (this.checked) {
            formDiv.style.display = 'block';
        } else {
            formDiv.style.display = 'none';
        }

        const params = new URLSearchParams(window.location.search);
        if (this.checked) {
            params.set('show_temp', '1');
        } else {
            params.delete('show_temp');
        }
        if (!params.has('quarter_id')) params.set('quarter_id', '{{ quarter.id }}');
        if (!params.has('department_id')) params.set('department_id', '{{ assignment.department.id }}');

        window.location.search = params.toString();
    });
    
    
    
    
</script>

{% else %}
<p>No assignments found for this quarter and department.</p>
{% endif %}

{% endblock %}
